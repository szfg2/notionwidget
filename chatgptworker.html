<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medical Document Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
      color: #555;
    }
    select, textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      resize: vertical;
      min-height: 40px;
    }
    textarea {
      min-height: 100px;
    }
    button {
      display: block;
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #spinner {
      margin: 20px auto;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    pre {
      background: #f4f4f4;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 20px;
    }
    #copyBtn {
      margin-top: 10px;
      background-color: #008CBA;
    }
    #copyBtn:hover {
      background-color: #007bb5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Medical Document Generator</h1>

    <label for="dataInput">Clinical Data (Vitals, Labs, Imaging):</label>
    <textarea id="dataInput" placeholder="Enter clinical data..."></textarea>

    <label for="templateSelect">Choose a Document Template:</label>
    <select id="templateSelect" onchange="loadTemplate()">
      <option value="">-- Select a Template --</option>
      <option value="micu_am_rounds">Medical ICU AM Round</option>
    </select>

    <label for="templateInput">Document Template:</label>
    <textarea id="templateInput" placeholder="Enter template with placeholders..."></textarea>

    <label for="instructionSelect">Choose Special Instruction:</label>
    <select id="instructionSelect" onchange="loadSpecialInstruction()">
      <option value="">-- Select Special Instruction --</option>
      <option value="generic_instructions">Generic Instructions</option>
      <option value="strict_instructions">Strict Instructions</option>
    </select>

    <label for="instructionsInput">Special Instructions:</label>
    <textarea id="instructionsInput" rows="5">Fill in blanks. Only fill in information that is directly stated in the Clinical Data. If there is no explicit information, leave the blank empty without guessing or inferring. If lab values are present, do not display their units.</textarea>

    <button onclick="generateDocument()">Generate Document</button>

    <div id="spinner" style="display:none;"></div>

    <h2>Generated Document:</h2>
    <pre id="response"></pre>
    <button id="copyBtn" style="display:none;" onclick="copyToClipboard()">Copy to Clipboard</button>
  </div>

  <script>
    async function loadTemplate() {
      const templateSelect = document.getElementById('templateSelect');
      const templateInput = document.getElementById('templateInput');
      const selectedTemplate = templateSelect.value;

      if (selectedTemplate) {
        try {
          const response = await fetch('https://raw.githubusercontent.com/szfg2/notionwidget/main/templates/' + selectedTemplate + '.txt');
          if (!response.ok) {
            throw new Error('Template not found');
          }
          const templateText = await response.text();
          templateInput.value = templateText.trim();
        } catch (error) {
          alert('Failed to load template: ' + error.message);
        }
      } else {
        templateInput.value = '';
      }
    }

    async function loadSpecialInstruction() {
      const instructionSelect = document.getElementById('instructionSelect');
      const instructionsInput = document.getElementById('instructionsInput');
      const selectedInstruction = instructionSelect.value;

      if (selectedInstruction) {
        try {
          const response = await fetch('https://raw.githubusercontent.com/szfg2/notionwidget/main/special_instructions/' + selectedInstruction + '.txt');
          if (!response.ok) {
            throw new Error('Instruction template not found');
          }
          const instructionText = await response.text();
          instructionsInput.value = instructionText.trim();
        } catch (error) {
          alert('Failed to load special instruction: ' + error.message);
        }
      }
      // else do nothing if empty
    }

    async function generateDocument() {
      const data = document.getElementById('dataInput').value.trim();
      const template = document.getElementById('templateInput').value.trim();
      const instructions = document.getElementById('instructionsInput').value.trim();

      let prompt = '';

      if (template) {
        prompt = `
You are a medical scribe.
Use the following clinical data to fill into the document template.
Follow the special instructions carefully.
If lab values are present, do not display their units.

Clinical Data:
${data}

Document Template:
${template}

Special Instructions:
${instructions}

Return the completed document as plain text without showing any units for lab values.
        `;
      } else {
        prompt = `
You are a medical editor.
Edit and format the following clinical data according to the special instructions.

Clinical Data:
${data}

Special Instructions:
${instructions}

Return the revised clinical text as plain text without showing any units for lab values.
        `;
      }

      document.getElementById('spinner').style.display = "block";
      document.getElementById('response').textContent = "";
      document.getElementById('copyBtn').style.display = "none";

      try {
        const res = await fetch('https://chatgpt-proxy.chatgpt-helper.workers.dev', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        const dataOut = await res.json();
        document.getElementById('spinner').style.display = "none";
        document.getElementById('response').textContent = dataOut.response || "Error generating document.";
        if (dataOut.response) {
          document.getElementById('copyBtn').style.display = "block";
        }
      } catch (err) {
        document.getElementById('spinner').style.display = "none";
        document.getElementById('response').textContent = "Error: " + err.message;
      }
    }

    function copyToClipboard() {
      const text = document.getElementById('response').textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert("Document copied to clipboard!");
      });
    }
  </script>
</body>
</html>
